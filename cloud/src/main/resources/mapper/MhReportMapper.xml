<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="MhReport">
	<resultMap type="MhReport" id="MhReport">
		<id property="mhrNo" column="mhrNo"/>
		<result property="mhrTitle" column="mhrTitle"/>		
		<result property="mhrContent" column="mhrContent"/>
		<result property="mhrReadCnt" column="mhrReadCnt"/>
		<result property="mhrRegDate" column="mhrRegDate"/>
		<result property="mhrInfoDate" column="mhrInfoDate"/>
		<result property="mhrName" column="mhrName"/>
		<result property="mhrMage" column="mhrMage"/>
		<result property="mhrage" column="mhrage"/>
		<result property="mhrNation" column="mhrNation"/>
		<result property="mhrIllCode" column="mhrIllCode"/>
		<result property="mhrStatusCode" column="mhrStatusCode"/>
		<result property="mhrLocalCode" column="mhrLocalCode"/>
		<result property="mhrWriter" column="mhrWriter"/>
		<result property="mmNo" column="mmNo"/>
		<result property="mhrGen" column="mhrGen"/>
		<result property="mhrHeight" column="mhrHeight"/>
		<result property="mhrWeight" column="mhrWeight"/>
		<result property="mhrPhysical" column="mhrPhysical"/>
		<result property="mhrFace" column="mhrFace"/>
		<result property="mhrHairColor" column="mhrHairColor"/>
		<result property="mhrHair" column="mhrHair"/>
		<result property="mhrWear" column="mhrWear"/>
		<result property="mhrDelYn" column="mhrDelYn"/>
		<result property="mhrAddFile" column="mhrAddFile"/>
	</resultMap>
	<sql id="mhSearch">
		<if test="type == 'title'">
			AND mhrTitle LIKE '%' ||#{keyword}|| '%'
		</if>
		<if test="type == 'writer'">
			AND mhrWriter LIKE '%' ||#{keyword}|| '%'
		</if>
	</sql>
	<select id="mhrSelectList" resultType="MhReport" parameterType="hashmap">
		SELECT rNum
        ,mhrNo
        ,mhrReadCnt
        ,mhrRegDate
        ,mhrTitle
        ,mhrWriter
	FROM (SELECT rownum as rNum
            ,mhrNo
            ,mhrReadCnt
            ,mhrRegDate
            ,mhrTitle
            ,mhrWriter
        FROM(SELECT mhrNo
                   ,mhrReadCnt
                   ,mhrRegDate
                   ,mhrTitle
                   ,mhrWriter
              FROM
                mhreport
             WHERE 
              mhrDelYn = 'N'
              <include refid="mhSearch"></include>
              <if test="mhName != null and mhName != ''">
					AND mhrName LIKE '%' || #{mhName} || '%'
					OR mhrTitle LIKE '%' || #{mhName} || '%'
					OR mhrContent LIKE '%' || #{mhName} || '%'
				</if> 	  
               <if test="mhGen != null">
					AND mhrGen = #{mhGen}
				</if>
            
             <!--	
              <if test="(mhInfoDate1 != null and mhInfoDate1 != '') and (mhInfoDate2 != null and mhInfoDate2 != '')">
					AND mhrInfoDate BETWEEN #{mhInfoDate1} AND #{mhInfoDate2} 
				</if>
              	<if test="(mhInfoDate1 == null or mhInfoDate1 == '') and (mhInfoDate2 != null and mhInfoDate2 != '')">
					AND mhrInfoDate <![CDATA[ < ]]> #{mhInfoDate2}
				</if>

              	<if test="(mhInfoDate1 != null and mhInfoDate1 != '') and (mhInfoDate2 == null or mhInfoDate2 == '')">
					AND mhrInfoDate <![CDATA[ > ]]> #{mhInfoDate1}
				</if>
              	<if test="(mhrLocalCode != null and mhrLocalCode != '')">
					AND mhrLocalCode = #{mhrLocalCode}
				</if> -->
             ORDER BY 
                mhrNo DESC)
                    )
WHERE
    rNum BETWEEN #{startRow} and #{startRow} + #{pagesize} -1
	</select>
	<select id="mhrSelectDetail" resultType="MhReport" resultMap="MhReport">
		SELECT
			mhrNo, mhrName,mhrMage, mhrage,mhrIllCode, mhrGen, mhrHeight,mhrWeight,mhrFace,mhrHairColor, 
			mhrHair, mhrWear, mhrStatusCode, mhrLocalCode, mhrTitle, mhrContent,mhrDelYn,mhrRegDate,
			mhrReadCnt,mhrAddFile,mhrInfoDate
		FROM
			mhreport
			
		WHERE
			mhrNo = #{mhrNo} and
			mhrDelYn = 'N'
			
	</select>
	<insert id="mhrInsert" parameterType="MhReport">
	 INSERT INTO mhreport(mhrNo, mhrTitle
	 									, mhrContent, mhrRegDate
	 									, mhrInfoDate, mhrName
	 									, mhrMage, mhrage
	 									, mhrNation, mhrIllCode
	 									, mhrStatusCode, mhrLocalCode
	 									, mhrWriter, mmNo
	 									, mhrGen, mhrHeight
	 									, mhrWeight, mhrPhysical
	 									, mhrFace, mhrHairColor
	 									, mhrHair, mhrWear
	 									<if test="mhrAddFile != null">
	 									,mhrAddFile
	 									</if>
	 									)
	 	VALUES(MHREPORT_seq.NEXTVAL, #{mhrTitle}
	 				, #{mhrContent}, SYSTIMESTAMP
	 				, #{mhrInfoDate}, #{mhrName}
	 				, #{mhrMage}, #{mhrage}
	 				, #{mhrNation}, #{mhrIllCode}
	 				, #{mhrStatusCode}, #{mhrLocalCode}
	 				, #{mhrWriter}, #{mmNo}
	 				, #{mhrGen}, #{mhrHeight, jdbcType=VARCHAR}
	 				, #{mhrWeight, jdbcType=VARCHAR}, #{mhrPhysical, jdbcType=VARCHAR}
	 				, #{mhrFace, jdbcType=VARCHAR}, #{mhrHairColor, jdbcType=VARCHAR}
	 				, #{mhrHair, jdbcType=VARCHAR}, #{mhrWear, jdbcType=VARCHAR}
	 				<if test="mhrAddFile != null">
	 				, #{mhrAddFile}
	 				</if>
	 				)
	</insert>
	<update id="mhrUpdate" parameterType="MhReport">
		UPDATE
			mhreport
		SET
			mhrTitle=#{mhrTitle},
			mhrContent=#{mhrContent},
			mhrName=#{mhrName},
			mhrMage=#{mhrMage},
			mhrage=#{mhrage},
			mhrInfoDate=#{mhrInfoDate},
			mhrHeight=#{mhrHeight, jdbcType=VARCHAR},
			mhrWeight=#{mhrWeight, jdbcType=VARCHAR},
			mhrPhysical=#{mhrPhysical, jdbcType=VARCHAR},
			mhrFace=#{mhrFace, jdbcType=VARCHAR},
			mhrHairColor=#{mhrHairColor, jdbcType=VARCHAR},
			mhrHair=#{mhrHair, jdbcType=VARCHAR},
			mhrWear=#{mhrWear, jdbcType=VARCHAR}
			<if test="mhrAddFile != null">
			,mhrAddFile = #{mhrAddFile} 
			</if>
		WHERE
			mhrNo=#{mhrNo}
	</update>
	<update id="mhrDelete" parameterType="MhReport">
		UPDATE
			mhreport
		SET
			mhrDelYn = 'Y'
		WHERE
			mhrNo=#{mhrNo}
	</update>
	<select id ="mhrListCount" resultType="int">
		SELECT
			count(*)
		FROM
			mhreport
		WHERE
			mhrDelYn = 'N'
	</select>
	<update id="mhrReadCount" parameterType="int">
	UPDATE
		mhreport
	SET
		mhrReadCnt = (SELECT MAX(mhrReadCnt)
								FROM
									mhreport
								WHERE
									mhrNo = #{mhrNo})+ 1
	WHERE
		mhrNo = #{mhrNo}
	</update>
	<!-- 통합검색 -->
	<select id="uSearch" resultType="Object">
	SELECT
    rno, searchNo, searchTitle, searchContent, searchTableType, searchRegdate, searchWriter
	FROM
	    (SELECT
	        rownum as rno, search.no as searchNo, search.title as searchTitle, search.content as searchContent, search.tableType as searchTableType, search.regdate as searchRegdate, search.writer as searchWriter
	    FROM
	        (SELECT
	             mhf.mhfNo as no, mhf.mhfTitle as title, mhf.mhfContent as content, mhf.tableType as tableType, mhf.mhfRegDate as regdate, mhf.mhfWriter as writer
	        FROM
	            mhfind mhf
	        UNION ALL
	        SELECT
	            mhr.mhrNo as no, mhr.mhrTitle as title, mhr.mhrContent as content, mhr.tableType as tableType, mhr.mhrRegDate as regdate, mhr.mhrWriter as writer
	        FROM
	            mhreport mhr
	        UNION ALL
	        SELECT
	            mn.mnNo as no, mn.mnTitle as title, mn.mnContent as content, mn.tableType as tabletype, mn.mnRegDate as regdate, mn.mnWriter as writer
	        FROM
	            mnotice mn
	        UNION ALL
	        SELECT
	            mq.mqNo as no, mq.mqTitle as title, mq.mqContent as content, mq.tableType as tableType, mq.mqRegDate as regdate, mq.mqWriter as writer
	        FROM
	            mqna mq
	        UNION ALL
	        SELECT
	            mpf.mpfNo as no, mpf.mpfTitle as title, mpf. mpfContent as content, mpf.tableType as tableType, mpf.mpfRegDate as regdate, mpf.mpfWriter as writer
	        FROM
	            mpfind mpf
	        UNION ALL
	        SELECT
	            mpp.mppNo as no, mpp.mppTitle as title, mpp.mppContent as content, mpp.tableType as tableType, mpp.mppRegDate as regdate, mpp.mppwriter as writer
	        FROM
	            mpprotect mpp
	        UNION ALL
	        SELECT
	            mpr.mprNo as no, mpr.mprTitle as title, mpr.mprContent as content, mpr.tableType as tableType, mpr.mprRegDate as regdate, mpr.mprWriter as writer
	        FROM
	            mpreport mpr
	        UNION ALL
	        SELECT
	            mre.mreNo as no, mre.mreTitle as title, mre.mreContent as content, mre.tableType as tableType, mre.mreRegDate as regdate, mre.mreWriter as writer
	        FROM
	            mrequest mre
	        ORDER BY
	            tableType asc, regdate desc, no desc) search
	    WHERE
	    	 search.title LIKE '%'||'#{keyword}'||'%' or search.content LIKE '%'||'#{keyword}'||'%' or search.regdate LIKE '%'||'#{keyword}'||'%'
        or search.writer LIKE '%'||'#{keyword}'||'%')
	</select>
</mapper>
